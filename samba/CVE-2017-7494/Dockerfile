FROM docker.io/debian:buster
# FROM --platform=$BUILDPLATFORM docker.io/debian:buster

MAINTAINER Mohamed Bana <mohamed@bana.io>
LABEL maintainer "Mohamed Bana <mohamed@bana.io>"

RUN apt-get update -y && \
    apt-get upgrade -y && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    acl attr autoconf bison build-essential \
    debhelper dnsutils docbook-xml docbook-xsl flex gdb krb5-user \
    libacl1-dev libaio-dev libattr1-dev libblkid-dev libbsd-dev \
    libcap-dev libcups2-dev libgnutls28-dev libjson-perl \
    libldap2-dev libncurses5-dev libpam0g-dev libparse-yapp-perl \
    libpopt-dev libreadline-dev perl perl-modules pkg-config \
    python-all-dev python-dev python-dnspython python-crypto \
    xsltproc zlib1g-dev \
    iproute2 nmap iputils-ping vim sed && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Add sources and compile it
COPY src /src
RUN cd /src && \
    ./configure && \
    make && \
    make install

# Samba configuration
COPY smb.conf /usr/local/samba/etc/smb.conf

# Expose the samba to the network
EXPOSE 137/udp
EXPOSE 138/udp
EXPOSE 139/tcp
EXPOSE 445/tcp

RUN mkdir -pv /home/share
RUN chown 666:666 /home/share
RUN chmod o+rwx /home/share

ENTRYPOINT ["/usr/local/samba/sbin/smbd"]
CMD ["-F","-S","-s","/usr/local/samba/etc/smb.conf","--debuglevel=10"]
